<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itsthatjun.ecommerce.dao.ReturnDao">
    <resultMap id="returnDetailMap" type="com.itsthatjun.ecommerce.dto.ReturnDetail" autoMapping="true">
        <association property="returnRequest" javaType="com.itsthatjun.ecommerce.mbg.model.ReturnRequest" autoMapping="true">
            <id property="id" column="id"/>
            <result property="updatedAt" column="request_update"/>
        </association>

        <collection property="returnItemList" ofType="com.itsthatjun.ecommerce.mbg.model.ReturnItem">
            <result property="productSku" column="product_sku"/>
            <result property="quantity" column="quantity"/>
        </collection>

        <collection property="picturesList" ofType="com.itsthatjun.ecommerce.mbg.model.ReturnReasonPictures">
            <result property="filename" column="filename"/>
        </collection>
        <collection property="logList" ofType="com.itsthatjun.ecommerce.mbg.model.ReturnLog">
            <result property="action" column="action"/>
            <result property="operator" column="last_updated_by" />
            <result property="createdAt" column="last_update_time"/>
        </collection>
    </resultMap>

    <select id="getDetail" resultMap="returnDetailMap">
        SELECT
            request.id,
            request.order_id,
            company_address_id,
            request.order_sn,
            request.member_id,
            request.return_quantity,
            request.return_name,
            request.return_phone,
            request.status,
            request.handle_time,
            request.asking_amount,
            request.refunded_amount,
            request.reason,
            request.description,
            request.handle_note,
            request.handle_operator,
            request.receive_operator,
            request.receive_time,
            request.receive_note,
            request.created_at,
            request.updated_at request_update,

            item.product_sku,
            item.quantity,

            picture.filename,

            log.action,
            log.operator last_update_time,
            log.created_at last_updated_by
        FROM return_request request
        LEFT JOIN return_item item ON return_request_id = request.id
        LEFT JOIN return_reason_pictures picture ON picture.return_request_id = request.id
        LEFT JOIN return_log log ON log.return_request_id = request.id
        WHERE request.order_sn = #{orderSn}
    </select>
</mapper>